#!/bin/bash
# https://til.simonwillison.net/cloudrun/using-build-args-with-cloud-run

if [[ -z "$NAME" ]]; then
    echo "Must provide NAME environment variable" 1>&2
    exit 1
fi


if [[ -z "$DATABASE_URL" ]]; then
    echo "Must provide DATABASE_URL environment variable" 1>&2
    exit 1
fi

if [[ -z "$STRAPI_BASE_URL" ]]; then
    echo "Must provide STRAPI_BASE_URL environment variable" 1>&2
    exit 1
fi

NAME="$NAME"
PROJECT=$(gcloud config get-value project)
IMAGE="gcr.io/$PROJECT/$NAME"

# Need YAML so we can set --build-arg
echo "
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', '$IMAGE', '.', '--build-arg', 'DATABASE_URL="$DATABASE_URL"']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', '$IMAGE']
" > /tmp/cloudbuild.yml

gcloud builds submit --config /tmp/cloudbuild.yml

rm /tmp/cloudbuild.yml

gcloud run deploy $NAME \
  --allow-unauthenticated \
  --set-env-vars=STRAPI_BASE_URL="$STRAPI_BASE_URL" \
  --image $IMAGE
